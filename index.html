<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Дашборд по проектам</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Небольшие улучшения таблицы */
    .status-Готово { background:#ecfdf5; color:#065f46; }
    .status-В\ процессе { background:#eff6ff; color:#1e40af; }
    .status-Неизвестно { background:#fff7ed; color:#9a3412; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold">Статусы поставок</h1>
        <p class="text-sm text-gray-500">Интерактивная сводка по этапам: Оплата → Отправка → Подготовка документов → Таможня → Доставка</p>
      </div>
      <div class="flex gap-2">
        <button id="copyBtn" class="px-3 py-2 rounded-xl bg-black text-white text-sm hover:opacity-90">Скопировать таблицу</button>
        <button id="downloadBtn" class="px-3 py-2 rounded-xl bg-white border text-sm">Скачать CSV</button>
      </div>
    </header>

    <!-- Фильтры -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-3">
      <div class="col-span-1 md:col-span-2">
        <label class="text-xs text-gray-500">Поиск по названию</label>
        <input id="q" type="search" placeholder="Например: Илосос, Конвейерная линия…" class="w-full mt-1 rounded-xl border px-3 py-2" />
      </div>
      <div>
        <label class="text-xs text-gray-500">Статус</label>
        <select id="status" class="w-full mt-1 rounded-xl border px-3 py-2"></select>
      </div>
      <div>
        <label class="text-xs text-gray-500">Этап</label>
        <select id="stage" class="w-full mt-1 rounded-xl border px-3 py-2"></select>
      </div>
    </section>

    <!-- KPI карточки -->
    <section id="kpi" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3"></section>

    <!-- Прогресс по проектам -->
    <section class="space-y-2">
      <h2 class="text-lg font-medium">Прогресс по проектам</h2>
      <div id="projects" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3"></div>
    </section>

    <!-- Таблица -->
    <section class="space-y-2">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-medium">Все этапы</h2>
        <span id="rowsCount" class="text-sm text-gray-500"></span>
      </div>
      <div class="overflow-x-auto bg-white rounded-2xl shadow">
        <table class="min-w-full text-sm" id="table">
          <thead class="bg-gray-100 text-gray-600">
            <tr>
              <th class="text-left px-4 py-3">Название</th>
              <th class="text-left px-4 py-3">Этап</th>
              <th class="text-left px-4 py-3">Статус</th>
              <th class="text-left px-4 py-3 whitespace-nowrap">Дата прибытия</th>
              <th class="text-left px-4 py-3">Комментарий</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // === ДАННЫЕ (встроены) ===
    const raw = [
      {"Название":"Телеинспекция","Этап":"Оплата","Статус":"Готово","Дата Прибытия":"26.08.2025","Комментарий":""},
      {"Название":"","Этап":"Отправка","Статус":"Готово","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Подогтовка документов для таможни","Статус":"Готово","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Таможенное оформление","Статус":"Готово","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Доставка до Караганды","Статус":"Готово","Дата Прибытия":"","Комментарий":""},
      {"Название":"Канапромывочная Машина Man","Этап":"Оплата","Статус":"Готово","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Отправка","Статус":"Готово","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Подогтовка документов для таможни","Статус":"В процессе","Дата Прибытия":"02.09.2025","Комментарий":""},
      {"Название":"","Этап":"Таможенное оформление","Статус":"В процессе","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Доставка до Караганды","Статус":"В процессе","Дата Прибытия":"20.09.2025-30.09.2025","Комментарий":"Ориентировочно"},
      {"Название":"Илосос SCANIA","Этап":"Оплата","Статус":"Готово","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Отправка","Статус":"Готово","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Подогтовка документов для таможни","Статус":"В процессе","Дата Прибытия":"02.09.2025","Комментарий":""},
      {"Название":"","Этап":"Таможенное оформление","Статус":"В процессе","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Доставка до Караганды","Статус":"В процессе","Дата Прибытия":"20.09.2025-30.09.2025","Комментарий":"Ориентировочно"},
      {"Название":"УФ Оборудование","Этап":"Оплата","Статус":"Готово","Дата Прибытия":"25.09.2025","Комментарий":""},
      {"Название":"","Этап":"Отправка","Статус":"В процессе","Дата Прибытия":"03.09.2025-05.09.2025","Комментарий":"Запланировано"},
      {"Название":"","Этап":"Подогтовка документов для таможни","Статус":"В процессе","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Таможенное оформление","Статус":"В процессе","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Доставка до Караганды","Статус":"В процессе","Дата Прибытия":"15.09.2025","Комментарий":"Ориентировочно"},
      {"Название":"Конвейерная линия","Этап":"Оплата","Статус":"Готово","Дата Прибытия":"","Комментарий":""},
      {"Название":"","Этап":"Отправка","Статус":"Неизвестно","Дата Прибытия":"","Комментарий":"Груз не готов"},
      {"Название":"","Этап":"Подогтовка документов для таможни","Статус":"Неизвестно","Дата Прибытия":"","Комментарий":"Груз не готов"},
      {"Название":"","Этап":"Таможенное оформление","Статус":"Неизвестно","Дата Прибытия":"","Комментарий":"Груз не готов"},
      {"Название":"","Этап":"Доставка до Караганды","Статус":"Неизвестно","Дата Прибытия":"","Комментарий":"Груз не готов"}
    ];

    // Нормализация этапов + протягивание названия проекта вниз
    const STAGE_ORDER = [
      'Оплата',
      'Отправка',
      'Подготовка документов для таможни',
      'Таможенное оформление',
      'Доставка до Караганды'
    ];

    function normalizeStage(s){
      if(!s) return s;
      // Исправляем распространённую опечатку
      return s.replace('Подогтовка', 'Подготовка');
    }

    function hydrate(rows){
      let currentName = '';
      return rows.map(r=>{
        const name = r['Название'] && r['Название'].trim() ? r['Название'].trim() : currentName;
        if (r['Название'] && r['Название'].trim()) currentName = r['Название'].trim();
        return {
          name,
          stage: normalizeStage(r['Этап']?.trim()||''),
          status: (r['Статус']||'').trim(),
          eta: (r['Дата Прибытия']||'').trim(),
          note: (r['Комментарий']||'').trim()
        }
      });
    }

    const data = hydrate(raw);

    // Уникальные значения для фильтров
    const uniq = (arr)=>[...new Set(arr.filter(Boolean))];
    const statuses = uniq(data.map(d=>d.status));
    const stages = uniq(data.map(d=>d.stage));

    // Инициализация селектов
    const statusSel = document.getElementById('status');
    const stageSel = document.getElementById('stage');

    function fillSelect(sel, values, placeholder){
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = placeholder;
      sel.appendChild(opt0);
      values.forEach(v=>{
        const o = document.createElement('option');
        o.value = v; o.textContent = v; sel.appendChild(o);
      });
    }

    fillSelect(statusSel, statuses, 'Все статусы');
    fillSelect(stageSel, stages, 'Все этапы');

    // Фильтрация
    const q = document.getElementById('q');
    const tbody = document.getElementById('tbody');
    const rowsCount = document.getElementById('rowsCount');

    function applyFilters(){
      const qs = q.value.trim().toLowerCase();
      const st = statusSel.value;
      const sg = stageSel.value;
      const filtered = data.filter(d=>{
        const okQ = !qs || d.name.toLowerCase().includes(qs);
        const okS = !st || d.status===st;
        const okG = !sg || d.stage===sg;
        return okQ && okS && okG;
      });
      renderTable(filtered);
      renderKPI(filtered);
      renderProjects(filtered);
    }

    [q, statusSel, stageSel].forEach(el=>el.addEventListener('input', applyFilters));

    // Рендер таблицы
    function badge(status){
      const cls = `inline-flex items-center px-2 py-1 rounded-full text-xs font-medium status-${status.replaceAll(' ','\\ ').replaceAll('ё','е')}`;
      return `<span class="${cls}">${status}</span>`;
    }

    function renderTable(rows){
      tbody.innerHTML = rows.map(r=>`
        <tr class="border-b last:border-0">
          <td class="px-4 py-2">${r.name||'<span class=\"text-gray-400\">—</span>'}</td>
          <td class="px-4 py-2">${r.stage}</td>
          <td class="px-4 py-2">${badge(r.status)}</td>
          <td class="px-4 py-2 whitespace-nowrap">${r.eta||'<span class=\"text-gray-400\">—</span>'}</td>
          <td class="px-4 py-2">${r.note||''}</td>
        </tr>
      `).join('');
      rowsCount.textContent = `${rows.length} строк(и)`;
    }

    // KPI
    function renderKPI(rows){
      const wrap = document.getElementById('kpi');
      const byStatus = Object.fromEntries(statuses.map(s=>[s,0]));
      let projects = new Set();
      rows.forEach(r=>{ byStatus[r.status] = (byStatus[r.status]||0)+1; projects.add(r.name); });
      const cards = [
        {label:'Проектов', value: projects.size},
        ...statuses.map(s=>({label:s, value: byStatus[s]||0}))
      ];
      wrap.innerHTML = cards.map(c=>`
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="text-xs text-gray-500">${c.label}</div>
          <div class="text-2xl font-semibold">${c.value}</div>
        </div>
      `).join('');
    }

    // Прогресс по проектам
    function renderProjects(rows){
      // Группируем по проекту
      const byProject = new Map();
      rows.forEach(r=>{
        if(!byProject.has(r.name)) byProject.set(r.name, []);
        byProject.get(r.name).push(r);
      });

      const container = document.getElementById('projects');
      const html = [];
      byProject.forEach((items, name)=>{
        const orderIndex = Object.fromEntries(STAGE_ORDER.map((s,i)=>[s,i]));
        const present = new Set(items.map(i=>i.stage));
        const done = items.filter(i=>i.status==='Готово').length;
        const total = STAGE_ORDER.length;
        const pct = Math.round((done/total)*100);

        const nextEta = items
          .filter(i=>i.eta)
          .sort((a,b)=>a.eta.localeCompare(b.eta))[0]?.eta || '';

        html.push(`
          <div class="bg-white rounded-2xl shadow p-4 space-y-2">
            <div class="flex items-center justify-between gap-2">
              <div class="font-medium">${name||'Без названия'}</div>
              <div class="text-xs text-gray-500">${pct}%</div>
            </div>
            <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
              <div style="width:${pct}%" class="h-2 bg-gray-900"></div>
            </div>
            <div class="flex flex-wrap gap-1">
              ${STAGE_ORDER.map(st=>`
                <span class="text-xs px-2 py-1 rounded-full border ${present.has(st)?'bg-gray-50':'opacity-50'}">${st}</span>
              `).join('')}
            </div>
            ${nextEta ? `<div class="text-xs text-gray-500">Ближайшая дата: <span class="font-medium text-gray-700">${nextEta}</span></div>`: ''}
          </div>
        `);
      });
      container.innerHTML = html.join('');
    }

    // Копировать таблицу в буфер
    document.getElementById('copyBtn').addEventListener('click', ()=>{
      const rows = [['Название','Этап','Статус','Дата прибытия','Комментарий']];
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        const tds = [...tr.querySelectorAll('td')].map(td=>td.innerText.replace(/\n/g,' ').trim());
        rows.push(tds);
      });
      const text = rows.map(r=>r.join('\t')).join('\n');
      navigator.clipboard.writeText(text).then(()=>{
        notify('Таблица скопирована');
      });
    });

    // Скачать CSV
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      const rows = [['Название','Этап','Статус','Дата прибытия','Комментарий']];
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        const tds = [...tr.querySelectorAll('td')].map((td,i)=>{
          // Удаляем визуальные артефакты из столбца статус
          return i===2 ? td.innerText.trim() : td.innerText.replace(/\n/g,' ').trim();
        });
        rows.push(tds);
      });
      const csv = rows.map(r=>r.map(c=>`"${c.replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'dashboard_export.csv';
      a.click();
    });

    // Простое уведомление
    function notify(msg){
      const div = document.createElement('div');
      div.className = 'fixed bottom-4 right-4 bg-black text-white text-sm px-3 py-2 rounded-xl shadow';
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(()=>div.remove(), 1800);
    }

    // Первый рендер
    applyFilters();
  </script>
</body>
</html>
